# 证件照微信小程序

一个功能完善的证件照制作微信小程序，前端使用微信小程序原生开发，后端使用 Node.js + Express 作为代理层调用 HivisionIDPhotos API 服务。

## 项目特点

- 🚀 **无需登录** - 历史记录保存在本地，即开即用
- 💾 **不持久化** - 图片不存储在服务器，保护隐私
- 🎁 **免费使用** - 下载时观看激励视频广告即可
- 🎨 **界面清新** - 卡片式设计，简洁易用

## 整体架构

```
┌─────────────────┐      ┌──────────────────┐      ┌─────────────────────────┐
│  微信小程序前端  │ ───▶ │  Node.js 后端    │ ───▶ │  HivisionIDPhotos API   │
│  (原生开发)      │      │  (API 代理层)     │      │  (Docker 已部署)        │
└─────────────────┘      └──────────────────┘      └─────────────────────────┘
                               │
                               ▼
                        ┌──────────────────┐
                        │  微信激励视频广告  │
                        └──────────────────┘
```

## 项目目录结构

```
IdPhoto-weapp/
├── miniprogram/                 # 微信小程序前端
│   ├── pages/
│   │   ├── index/               # 首页 - 选择证件照类型
│   │   ├── upload/              # 上传照片页面
│   │   ├── edit/                # 编辑页面（调整参数）
│   │   └── preview/             # 预览与下载页面
│   ├── components/              # 公共组件
│   ├── utils/                   # 工具函数
│   ├── data/                    # 数据文件
│   ├── app.js
│   ├── app.json
│   └── app.wxss
├── server/                      # Node.js 后端（API 代理）
│   ├── src/
│   │   ├── controllers/
│   │   ├── services/
│   │   ├── routes/
│   │   ├── middleware/
│   │   └── config/
│   ├── package.json
│   └── server.js
└── README.md
```

## 核心功能

### 1. 证件照类型
- **常用尺寸**：一寸、二寸、小二寸等
- **考试证件照**：四六级、考研、公务员等
- **签证/护照**：美国签证、日本签证、护照等

### 2. 用户交互流程

```
首页选择类型 → 上传照片 → AI处理 → 预览编辑 → 选择背景色 → 生成排版照 → 观看广告 → 保存/下载
```

### 3. API 接口

| 业务功能 | HivisionIDPhotos 接口 | 说明 |
|---------|---------------------|------|
| 上传并生成证件照 | `idphoto` | 抠图 + 裁切 + 透明底 |
| 更换背景色 | `add_background` | 添加背景色 |
| 生成排版照 | `generate_layout_photos` | 六寸排版 |
| 照片调整 | `idphoto_crop` | 重新裁切 |
| KB调整 | `set_kb` | 调整文件大小 |
| 人像抠图 | `human_matting` | 纯抠图功能 |

## 技术栈

### 前端（微信小程序）
- 微信小程序原生框架
- Canvas API
- 激励视频广告组件

### 后端（Node.js）
- Express.js
- Multer（文件上传）
- Axios（HTTP 请求）
- Cors（跨域处理）

### 外部服务
- HivisionIDPhotos API
- 微信激励视频广告

## 开发步骤

### 第一阶段：基础框架搭建
1. 初始化微信小程序项目
2. 初始化 Node.js 后端项目（Express）
3. 配置后端中间件（CORS、日志、文件上传）
4. 搭建基础路由和错误处理

### 第二阶段：后端 API 开发
1. 实现 HivisionIDPhotos 服务封装
2. 实现证件照生成接口（/api/idphoto/generate）
3. 实现背景色更换接口（/api/idphoto/change-bg）
4. 实现排版照生成接口（/api/idphoto/layout）
5. 实现其他辅助接口（KB调整、参数调整等）
6. 实现证件照尺寸接口（返回内置数据）

### 第三阶段：前端页面开发
1. 首页：证件照类型选择（分类展示）
2. 上传页面：拍照/相册选择
3. 编辑页面：参数调整和实时预览
4. 预览页面：结果展示和广告组件
5. 历史记录页面（本地存储）
6. 工具函数：API 封装、本地存储、图片处理

### 第四阶段：广告集成
1. 申请微信流量主
2. 创建激励视频广告位
3. 在预览页面集成广告组件
4. 实现观看广告后解锁下载功能

### 第五阶段：集成与测试
1. 前后端联调
2. 功能测试（各种证件照尺寸）
3. 广告功能测试
4. 性能优化
5. 用户体验优化

### 第六阶段：部署上线
1. 后端服务部署（云服务器）
2. 配置域名和 HTTPS
3. 小程序配置服务器域名
4. 提交小程序审核

## 环境配置要求

### 开发环境
- Node.js >= 16.x
- 微信开发者工具
- HivisionIDPhotos Docker 服务运行中

### 生产环境
- 云服务器（阿里云、腾讯云等）
- 域名 + SSL 证书
- HivisionIDPhotos 服务部署
- 小程序已认证（个人或企业）

## 开始开发

### 1. 克隆项目
```bash
git clone <repository-url>
cd IdPhoto-weapp
```

### 2. 启动后端服务
```bash
cd server
npm install
npm run dev
```

### 3. 配置小程序
1. 用微信开发者工具打开 `miniprogram` 目录
2. 配置 AppID
3. 修改 `miniprogram/utils/config.js` 中的后端地址
4. 点击编译运行

## 注意事项

1. **域名配置**：小程序需要配置合法的服务器域名
2. **文件大小限制**：小程序上传文件大小限制为 10MB
3. **Base64 处理**：返回的图片为 base64 格式，需要转换为临时文件
4. **广告组件**：需要小程序累计用户达到 1000 后才能申请流量主
5. **性能优化**：AI 处理较耗时（3-10秒），需要显示加载动画

## 开源协议

MIT License

## 联系方式

如有问题，欢迎提 Issue。
